name: build-and-push-image
description: build-and-push-image
inputs:
  role-to-assume:
    required: true
  aws-region:
    required: true
  aws-ecr-registry:
    required: true
  aws-ecr-repository:
    required: true
runs:
  using: composite
  steps:
    - id: setup-node
      name: setup node
      uses: actions/setup-node@v3
      with:
        node-version: 16.13.1
    - id: yarn
      name: yarn
      run: |
        yarn install
        yarn build
      shell: bash
    - id: image-build
      name: image build
      run: docker build -t ${{ inputs.aws-ecr-registry }}/${{ inputs.aws-ecr-repository }}:latest .
      shell: bash
    - id: configure-aws-credentials
      name: configure aws credentials
      uses: aws-actions/configure-aws-credentials@v1.7.0
      with:
        role-to-assume: ${{inputs.role-to-assume}}
        role-session-name: github-actions-role
        aws-region: ${{inputs.aws-region}}
    - id: push-image
      name: push image
      run: |
        aws ecr get-login-password --region ${{inputs.aws-region}} | docker login --username AWS --password-stdin ${{ inputs.aws-ecr-registry }}
        docker push ${{ inputs.aws-ecr-registry }}/${{ inputs.aws-ecr-repository }}:latest
      shell: bash
